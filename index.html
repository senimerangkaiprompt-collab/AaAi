<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AaAi Prompt Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #3b82f6; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(26px); }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #4b5563; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; border: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -6px; }
        input[type=range]:disabled::-webkit-slider-thumb { background: #6b7280; }
        input[type=range]::-moz-range-track { width: 100%; height: 8px; cursor: pointer; background: #4b5563; border-radius: 5px; }
        input[type=range]::-moz-range-thumb { border: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; }
        input[type=range]:disabled::-moz-range-thumb { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased min-h-screen flex items-center justify-center p-2 sm:p-4">

    <!-- Container Utama -->
    <div id="app-container" class="w-full max-w-6xl mx-auto">

        <!-- ===== HALAMAN LOGIN ===== -->
        <div id="login-page" class="hidden fade-in">
            <div class="max-w-md mx-auto">
                <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl">
                    <div id="maintenance-notice" class="hidden mb-6 bg-yellow-900/50 border border-yellow-700 text-yellow-300 text-sm rounded-lg p-4 text-center">
                        <h3 class="font-bold mb-2">Pemberitahuan Perbaikan</h3>
                        <p id="maintenance-message-display"></p>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-center text-blue-400 mb-2">AaAi Prompt Generator</h1>
                    <p class="text-center text-gray-400 mb-8">Masuk untuk memulai</p>
                    <div class="flex border-b border-gray-700 mb-6">
                        <button id="show-member-login" class="flex-1 py-2 text-center font-semibold border-b-2 border-blue-400 text-white">Member</button>
                        <button id="show-admin-login" class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-white">Admin</button>
                    </div>
                    <form id="member-login-form">
                        <div class="mb-4">
                            <label for="voucher-code" class="block mb-2 text-sm font-medium text-gray-300">Kode Voucher</label>
                            <input type="text" id="voucher-code" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Masukkan kode unik Anda" required>
                        </div>
                        <button type="submit" id="member-login-btn" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Masuk sebagai Member</button>
                    </form>
                    <form id="admin-login-form" class="hidden">
                        <div class="mb-4">
                            <label for="admin-email" class="block mb-2 text-sm font-medium text-gray-300">Email Admin</label>
                            <input type="email" id="admin-email" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="email@admin.com" required>
                        </div>
                         <div class="mb-6">
                            <label for="admin-password" class="block mb-2 text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="admin-password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="••••••••" required>
                        </div>
                        <button type="submit" class="w-full text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Login Admin</button>
                    </form>
                    <p id="login-error" class="text-red-400 text-sm mt-4 text-center h-5"></p>
                </div>
                <div class="text-center mt-6">
                    <button id="show-request-modal-btn" class="text-blue-400 hover:text-blue-300 text-sm font-medium">Belum punya voucher? Minta akses di sini</button>
                </div>
            </div>
        </div>

        <!-- ===== HALAMAN MEMBER ===== -->
        <div id="member-page" class="hidden fade-in">
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 bg-gray-800 p-4 rounded-xl shadow-lg">
                <div class="mb-3 sm:mb-0">
                    <h1 class="text-xl font-bold text-blue-400">Selamat Datang, <span id="member-name"></span>!</h1>
                    <p class="text-sm text-gray-400">Paket: <span id="package-name-display" class="font-semibold"></span> | Sisa Waktu: <span id="expiry-time" class="font-semibold"></span></p>
                    <p id="usage-limit-display" class="text-sm text-yellow-400 mt-1"></p>
                </div>
                <button id="member-logout" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors self-end sm:self-center">Logout</button>
            </header>
            <div class="grid md:grid-cols-2 gap-6 md:gap-8">
                <div class="flex flex-col gap-6 md:gap-8">
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center">Unggah Gambar Inspirasi</h2>
                        <div id="image-upload-area" class="border-2 border-dashed border-gray-600 rounded-lg p-6 sm:p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-700 transition-colors">
                            <input type="file" id="image-input" class="hidden" accept="image/*">
                            <div id="upload-placeholder">
                                <svg class="mx-auto h-12 w-12 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                                <p class="mt-2 text-sm text-gray-400">Klik untuk memilih gambar atau seret ke sini</p>
                            </div>
                            <img id="image-preview" src="" alt="Image Preview" class="hidden max-h-64 mx-auto rounded-lg">
                        </div>
                        <button id="generate-prompt-btn" class="mt-6 w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-lg px-5 py-3 text-center transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" disabled>Buat Prompt</button>
                        <p id="member-error" class="text-red-400 text-sm mt-4 text-center h-5"></p>
                    </div>
                    <div id="controls-and-copy-container" class="hidden">
                        <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                            <div id="advanced-controls-section">
                                <h3 class="text-lg sm:text-xl font-semibold mb-6 text-center text-blue-300">Sesuaikan Kontrol</h3>
                                <p id="premium-feature-lock" class="hidden text-center text-sm text-yellow-400 bg-yellow-900/50 p-2 rounded-md mb-4">Upgrade ke paket premium untuk menggunakan fitur ini.</p>
                                <div id="sliders-wrapper" class="space-y-6">
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-sm font-medium"><label for="artistic-style-slider" class="text-gray-300">Gaya Artistik:</label><span id="artistic-style-value" class="text-white font-semibold">Seimbang</span></div>
                                        <input type="range" id="artistic-style-slider" min="0" max="100" value="50" class="w-full">
                                        <div class="flex justify-between text-xs text-gray-400"><span>Ilustrasi</span><span>Fotografi</span></div>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-sm font-medium"><label for="detail-level-slider" class="text-gray-300">Tingkat Detail:</label><span id="detail-level-value" class="text-white font-semibold">Normal</span></div>
                                        <input type="range" id="detail-level-slider" min="0" max="100" value="50" class="w-full">
                                        <div class="flex justify-between text-xs text-gray-400"><span>Minimalis</span><span>Kompleks</span></div>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-sm font-medium"><label for="mood-slider" class="text-gray-300">Atmosfer/Mood:</label><span id="mood-value" class="text-white font-semibold">Netral</span></div>
                                        <input type="range" id="mood-slider" min="0" max="100" value="50" class="w-full">
                                        <div class="flex justify-between text-xs text-gray-400"><span>Cerah</span><span>Dramatis</span></div>
                                    </div>
                                </div>
                            </div>
                            <div id="copy-prompt-section" class="relative mt-6 pt-6 border-t border-gray-700">
                                <button id="copy-dropdown-toggle" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.353-.026.692-.026 1.038 0 .346.026.685.026 1.038 0 1.13.094 1.976 1.057 1.976 2.192V7.5M8.25 7.5h7.5M8.25 7.5V9a.75.75 0 01-.75.75H5.625a.75.75 0 01-.75-.75V7.5m11.25 0V9A.75.75 0 0018.375 9.75h-2.25A.75.75 0 0015.375 9V7.5m-7.5 0h7.5" /></svg>
                                    Salin Prompt
                                    <svg class="w-5 h-5 ml-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0-0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                                </button>
                                <div id="copy-dropdown-menu" class="hidden absolute bottom-full mb-2 w-full bg-gray-600 rounded-lg shadow-xl z-10">
                                    <button id="copy-indonesia-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-blue-500 rounded-t-lg">Salin Versi Indonesia</button>
                                    <button id="copy-english-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-blue-500 rounded-b-lg">Salin Versi English</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                    <h2 id="result-title" class="text-xl sm:text-2xl font-semibold mb-4 text-center">Hasil Prompt AI</h2>
                    <div id="prompt-result-area" class="space-y-4">
                        <div id="prompt-placeholder" class="text-center text-gray-500 py-16">
                             <svg class="mx-auto h-12 w-12 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-1.125 0-2.25.9-2.25 2.25v15c0 1.125.9 2.25 2.25 2.25h10.5c1.125 0 2.25-.9 2.25-2.25v-15c0-1.125-.9-2.25-2.25-2.25h-4.5m-7.5 12h15m-15-4.5h15m-15-4.5h15m-15-4.5h15" /></svg>
                            <p class="mt-2">Hasil prompt akan muncul di sini...</p>
                        </div>
                        <div id="loading-spinner" class="hidden text-center py-16">
                            <div class="spinner mx-auto"></div>
                            <p class="mt-4 text-gray-400">Menghubungi server aman...</p>
                        </div>
                        <div id="prompt-content" class="hidden space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ===== HALAMAN ADMIN ===== -->
        <div id="admin-page" class="hidden fade-in">
            <!-- ... Konten halaman admin Anda ... -->
        </div>
    </div>

    <!-- Modal Permintaan Voucher -->
    <div id="voucher-request-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 fade-in">
        <!-- ... Konten modal Anda ... -->
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 fade-in">
        <!-- ... Konten modal Anda ... -->
    </div>

    <!-- Firebase dan Logic Aplikasi -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, serverTimestamp, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6_SqZDftPnMNvOtPJ_WMD-yxz7qaMkDo",
            authDomain: "kunci-b42e7.firebaseapp.com",
            projectId: "kunci-b42e7",
            storageBucket: "kunci-b42e7.appspot.com",
            messagingSenderId: "29581913558",
            appId: "1:29581913558:web:ccad295d29918d545ec877",
            measurementId: "G-CN5M29JLK3"
        };
        
        const ADMIN_UID = "qk3es4chLkZpSosuRBbywS6v0VJ2";
        const ADMIN_WHATSAPP_NUMBER = "6289660111433";
        const DAILY_LIMIT = 5;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 
        const functions = getFunctions(app);

        let currentUserData = null;
        let lastGeneratedPromptData = null; 

        // [FUNGSI UTAMA] Memanggil Cloud Function dengan aman
        async function callSecureFunction() {
            // Referensi elemen DOM yang dibutuhkan di dalam fungsi ini
            const imageInput = document.getElementById('image-input');
            const memberError = document.getElementById('member-error');
            const controlsAndCopyContainer = document.getElementById('controls-and-copy-container');
            const loadingSpinner = document.getElementById('loading-spinner');
            const promptPlaceholder = document.getElementById('prompt-placeholder');
            const promptContent = document.getElementById('prompt-content');
            const generatePromptBtn = document.getElementById('generate-prompt-btn');

            if (!imageInput.files[0] || !currentUserData) return;
            memberError.textContent = '';
            
            controlsAndCopyContainer.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            promptPlaceholder.classList.add('hidden');
            promptContent.classList.add('hidden');
            generatePromptBtn.disabled = true;

            try {
                const file = imageInput.files[0];
                const base64ImageData = await imageToBase64(file);
                
                // Siapkan pemanggilan ke Cloud Function `generatePromptSecurely`
                const generatePrompt = httpsCallable(functions, 'generatePromptSecurely');
                
                // Panggil fungsi di backend
                const result = await generatePrompt({
                    base64Image: base64ImageData,
                    mimeType: file.type,
                    voucherCode: currentUserData.id,
                    deviceId: getDeviceId()
                });

                lastGeneratedPromptData = result.data;
                
                displayPromptResults(lastGeneratedPromptData);
                
                const settingsDoc = await getDoc(doc(db, "settings", "features"));
                const isAdvancedEnabled = settingsDoc.exists() && settingsDoc.data().advancedSlidersEnabled;
                document.getElementById('advanced-controls-section').style.display = isAdvancedEnabled ? 'block' : 'none';

                if (currentUserData.type === 'stater' || currentUserData.type === 'observer') {
                    if(currentUserData.type === 'stater'){
                        document.getElementById('premium-feature-lock').classList.remove('hidden');
                    }
                    document.getElementById('artistic-style-slider').disabled = true;
                    document.getElementById('detail-level-slider').disabled = true;
                    document.getElementById('mood-slider').disabled = true;
                    document.getElementById('sliders-wrapper').classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    document.getElementById('artistic-style-slider').disabled = false;
                    document.getElementById('detail-level-slider').disabled = false;
                    document.getElementById('mood-slider').disabled = false;
                    document.getElementById('sliders-wrapper').classList.remove('opacity-50', 'cursor-not-allowed');
                    document.getElementById('premium-feature-lock').classList.add('hidden');
                }
                controlsAndCopyContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error calling secure function:", error);
                memberError.textContent = `Gagal: ${error.message}`;
                promptPlaceholder.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
                generatePromptBtn.disabled = false;
            }
        }
        
        // --- Fungsi Helper (tidak diubah) ---
        function getDeviceId() { let id = localStorage.getItem('deviceId'); if (!id) { id = crypto.randomUUID(); localStorage.setItem('deviceId', id); } return id; }
        function imageToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); }
        // ... Semua fungsi helper Anda yang lain (displayPromptResults, handleCopy, sanitizeHTML, etc.) diletakkan di sini ...

        // --- [INISIALISASI APLIKASI YANG DIPERBAIKI] ---
        function startApp() {
            // Definisikan semua elemen DOM dan pasang event listener di sini
            // Ini memastikan semua elemen sudah ada sebelum diakses
            const loginPage = document.getElementById('login-page');
            const memberPage = document.getElementById('member-page');
            const adminPage = document.getElementById('admin-page');

            function showPage(pageId) {
                loginPage.classList.add('hidden');
                memberPage.classList.add('hidden');
                adminPage.classList.add('hidden');
                document.getElementById(pageId)?.classList.remove('hidden');
            }

            // Pasang semua event listener
            document.getElementById('generate-prompt-btn')?.addEventListener('click', callSecureFunction);
            document.getElementById('member-login-form')?.addEventListener('submit', async (e) => { /* ... logika login member Anda ... */ });
            document.getElementById('admin-login-form')?.addEventListener('submit', async (e) => { /* ... logika login admin Anda ... */ });
            document.getElementById('member-logout')?.addEventListener('click', async () => { /* ... logika logout Anda ... */ });
            // ... Tambahkan semua event listener lain di sini ...

            // Listener utama yang mengontrol UI
            onAuthStateChanged(auth, async (user) => {
                try {
                    const settingsDoc = await getDoc(doc(db, "settings", "features"));
                    const settings = settingsDoc.exists() ? settingsDoc.data() : {};

                    if (user && !user.isAnonymous && user.uid === ADMIN_UID) {
                        sessionStorage.removeItem('loggedInUser');
                        // setupAdminPage(); // Pastikan fungsi ini didefinisikan
                        showPage('admin-page');
                    } else {
                        const storedUser = sessionStorage.getItem('loggedInUser');
                        if (storedUser) {
                            // ... Logika untuk setup dan tampilkan halaman member ...
                            showPage('member-page');
                        } else {
                            if (settings.maintenanceModeEnabled) {
                                // ... Logika untuk menampilkan pesan maintenance ...
                            }
                            showPage('login-page');
                        }
                    }
                } catch (error) {
                    console.error("Auth state change error:", error);
                    document.body.innerHTML = '<div class="text-center text-red-400 p-8">Gagal memuat aplikasi.</div>';
                }
            });

            // Trigger inisialisasi awal
            if (!auth.currentUser) {
                signInAnonymously(auth).catch(err => {
                    console.error("Anonymous sign-in failed:", err);
                    document.body.innerHTML = '<div class="text-center text-red-400 p-8">Koneksi ke server gagal.</div>';
                });
            }
        }
        
        window.onload = startApp;
    </script>
</body>
</html>

