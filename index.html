<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AaAi Prompt Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #3b82f6;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /* Custom styles for range sliders */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px; /* Position thumb on the track */
        }
        input[type=range]:disabled::-webkit-slider-thumb {
            background: #6b7280;
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 5px;
        }
        input[type=range]::-moz-range-thumb {
            border: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
         input[type=range]:disabled::-moz-range-thumb {
            background: #6b7280;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased min-h-screen flex items-center justify-center p-2 sm:p-4">

    <!-- Container Utama -->
    <div id="app-container" class="w-full max-w-6xl mx-auto">

        <!-- ===== HALAMAN LOGIN ===== -->
        <div id="login-page" class="fade-in">
            <div class="max-w-md mx-auto">
                <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl">
                    <div id="maintenance-notice" class="hidden mb-6 bg-yellow-900/50 border border-yellow-700 text-yellow-300 text-sm rounded-lg p-4 text-center">
                        <h3 class="font-bold mb-2">Pemberitahuan Perbaikan</h3>
                        <p id="maintenance-message-display"></p>
                    </div>

                    <h1 class="text-2xl sm:text-3xl font-bold text-center text-blue-400 mb-2">AaAi Prompt Generator</h1>
                    <p class="text-center text-gray-400 mb-8">Masuk untuk memulai</p>

                    <div class="flex border-b border-gray-700 mb-6">
                        <button id="show-member-login" class="flex-1 py-2 text-center font-semibold border-b-2 border-blue-400 text-white">Member</button>
                        <button id="show-admin-login" class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-white">Admin</button>
                    </div>

                    <!-- Form Login Member -->
                    <form id="member-login-form">
                        <div class="mb-4">
                            <label for="voucher-code" class="block mb-2 text-sm font-medium text-gray-300">Kode Voucher</label>
                            <input type="text" id="voucher-code" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Masukkan kode unik Anda" required>
                        </div>
                        <button type="submit" id="member-login-btn" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Masuk sebagai Member</button>
                    </form>

                    <!-- Form Login Admin -->
                    <form id="admin-login-form" class="hidden">
                        <div class="mb-4">
                            <label for="admin-email" class="block mb-2 text-sm font-medium text-gray-300">Email Admin</label>
                            <input type="email" id="admin-email" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="email@admin.com" required>
                        </div>
                         <div class="mb-6">
                            <label for="admin-password" class="block mb-2 text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="admin-password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="••••••••" required>
                        </div>
                        <button type="submit" class="w-full text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Login Admin</button>
                    </form>
                    
                    <p id="login-error" class="text-red-400 text-sm mt-4 text-center h-5"></p>
                </div>
                
                <!-- Tombol Minta Voucher -->
                <div class="text-center mt-6">
                    <button id="show-request-modal-btn" class="text-blue-400 hover:text-blue-300 text-sm font-medium">Belum punya voucher? Minta akses di sini</button>
                </div>
            </div>
        </div>

        <!-- ===== HALAMAN MEMBER ===== -->
        <div id="member-page" class="hidden fade-in">
            <!-- Header Member -->
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 bg-gray-800 p-4 rounded-xl shadow-lg">
                <div class="mb-3 sm:mb-0">
                    <h1 class="text-xl font-bold text-blue-400">Selamat Datang, <span id="member-name"></span>!</h1>
                    <p class="text-sm text-gray-400">Paket: <span id="package-name-display" class="font-semibold"></span> | Sisa Waktu: <span id="expiry-time" class="font-semibold"></span></p>
                    <p id="usage-limit-display" class="text-sm text-yellow-400 mt-1"></p>
                </div>
                <button id="member-logout" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors self-end sm:self-center">Logout</button>
            </header>
            
            <div class="grid md:grid-cols-2 gap-6 md:gap-8">
                <!-- Kolom Kiri: Input & Kontrol -->
                <div class="flex flex-col gap-6 md:gap-8">
                    <!-- Card: Upload & Generate -->
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center">Unggah Gambar Inspirasi</h2>
                        <div id="image-upload-area" class="border-2 border-dashed border-gray-600 rounded-lg p-6 sm:p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-700 transition-colors">
                            <input type="file" id="image-input" class="hidden" accept="image/*">
                            <div id="upload-placeholder">
                                <svg class="mx-auto h-12 w-12 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                                </svg>
                                <p class="mt-2 text-sm text-gray-400">Klik untuk memilih gambar atau seret ke sini</p>
                            </div>
                            <img id="image-preview" src="" alt="Image Preview" class="hidden max-h-64 mx-auto rounded-lg">
                        </div>
                        
                        <button id="generate-prompt-btn" class="mt-6 w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-lg px-5 py-3 text-center transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Buat Prompt
                        </button>
                        <p id="member-error" class="text-red-400 text-sm mt-4 text-center h-5"></p>
                    </div>

                    <!-- Card: Advanced Controls & Copy - Default Hidden -->
                    <div id="controls-and-copy-container" class="hidden">
                        <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                             <!-- Fitur Kontrol Tambahan -->
                            <div id="advanced-controls-section">
                                <h3 class="text-lg sm:text-xl font-semibold mb-6 text-center text-blue-300">Sesuaikan Kontrol</h3>
                                <p id="premium-feature-lock" class="hidden text-center text-sm text-yellow-400 bg-yellow-900/50 p-2 rounded-md mb-4">
                                    Upgrade ke paket premium untuk menggunakan fitur ini.
                                </p>
                                <div id="sliders-wrapper" class="space-y-6">
                                    <!-- Gaya Artistik -->
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-sm font-medium">
                                            <label for="artistic-style-slider" class="text-gray-300">Gaya Artistik:</label>
                                            <span id="artistic-style-value" class="text-white font-semibold">Seimbang</span>
                                        </div>
                                        <input type="range" id="artistic-style-slider" min="0" max="100" value="50" class="w-full">
                                        <div class="flex justify-between text-xs text-gray-400">
                                            <span>Ilustrasi</span>
                                            <span>Fotografi</span>
                                        </div>
                                    </div>
                                    <!-- Tingkat Detail -->
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-sm font-medium">
                                            <label for="detail-level-slider" class="text-gray-300">Tingkat Detail:</label>
                                            <span id="detail-level-value" class="text-white font-semibold">Normal</span>
                                        </div>
                                        <input type="range" id="detail-level-slider" min="0" max="100" value="50" class="w-full">
                                        <div class="flex justify-between text-xs text-gray-400">
                                            <span>Minimalis</span>
                                            <span>Kompleks</span>
                                        </div>
                                    </div>
                                    <!-- Atmosfer/Mood -->
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-sm font-medium">
                                            <label for="mood-slider" class="text-gray-300">Atmosfer/Mood:</label>
                                            <span id="mood-value" class="text-white font-semibold">Netral</span>
                                        </div>
                                        <input type="range" id="mood-slider" min="0" max="100" value="50" class="w-full">
                                        <div class="flex justify-between text-xs text-gray-400">
                                            <span>Cerah</span>
                                            <span>Dramatis</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tombol Salin dengan Dropdown -->
                            <div id="copy-prompt-section" class="relative mt-6 pt-6 border-t border-gray-700">
                                <button id="copy-dropdown-toggle" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.353-.026.692-.026 1.038 0 .346.026.685.026 1.038 0 1.13.094 1.976 1.057 1.976 2.192V7.5M8.25 7.5h7.5M8.25 7.5V9a.75.75 0 01-.75.75H5.625a.75.75 0 01-.75-.75V7.5m11.25 0V9A.75.75 0 0018.375 9.75h-2.25A.75.75 0 0015.375 9V7.5m-7.5 0h7.5" /></svg>
                                    Salin Prompt
                                    <svg class="w-5 h-5 ml-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0-0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                                </button>
                                <div id="copy-dropdown-menu" class="hidden absolute bottom-full mb-2 w-full bg-gray-600 rounded-lg shadow-xl z-10">
                                    <button id="copy-indonesia-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-blue-500 rounded-t-lg">Salin Versi Indonesia</button>
                                    <button id="copy-english-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-blue-500 rounded-b-lg">Salin Versi English</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kolom Kanan: Hasil Prompt -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                    <h2 id="result-title" class="text-xl sm:text-2xl font-semibold mb-4 text-center">Hasil Prompt AI</h2>
                    <div id="prompt-result-area" class="space-y-4">
                        <div id="prompt-placeholder" class="text-center text-gray-500 py-16">
                             <svg class="mx-auto h-12 w-12 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-1.125 0-2.25.9-2.25 2.25v15c0 1.125.9 2.25 2.25 2.25h10.5c1.125 0 2.25-.9 2.25-2.25v-15c0-1.125-.9-2.25-2.25-2.25h-4.5m-7.5 12h15m-15-4.5h15m-15-4.5h15m-15-4.5h15" />
                             </svg>
                            <p class="mt-2">Hasil prompt akan muncul di sini...</p>
                        </div>
                        <div id="loading-spinner" class="hidden text-center py-16">
                            <div class="spinner mx-auto"></div>
                            <p class="mt-4 text-gray-400">AI sedang menganalisis gambar...</p>
                        </div>
                        <div id="prompt-content" class="hidden space-y-4">
                            <!-- Hasil akan dimasukkan di sini oleh JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ===== HALAMAN ADMIN ===== -->
        <div id="admin-page" class="hidden fade-in">
            <header class="flex justify-between items-center mb-6 bg-gray-800 p-4 rounded-xl shadow-lg">
                <h1 class="text-xl sm:text-2xl font-bold text-red-400">Dasbor Admin</h1>
                <button id="admin-logout" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Logout</button>
            </header>

            <!-- Dasbor Statistik -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Total Member</p><h3 id="total-members" class="text-2xl font-bold">0</h3></div>
                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-sm text-blue-400">Member Aktif</p><h3 id="active-members" class="text-2xl font-bold">0</h3></div>
                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-sm text-purple-400">Belum Aktif</p><h3 id="inactive-members" class="text-2xl font-bold">0</h3></div>
                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-sm text-green-400">Online</p><h3 id="online-members" class="text-2xl font-bold">0</h3></div>
                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-sm text-gray-400">Offline</p><h3 id="offline-members" class="text-2xl font-bold">0</h3></div>
            </div>

            <div class="grid lg:grid-cols-3 gap-6 md:gap-8">
                <!-- Kolom 1: Buat Voucher -->
                <div class="lg:col-span-1 bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4">Buat Voucher Baru</h2>
                    <form id="create-voucher-form" class="space-y-4">
                        <div>
                            <label for="new-member-name" class="block text-sm font-medium">Nama Member</label>
                            <input type="text" id="new-member-name" class="mt-1 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="new-member-city" class="block text-sm font-medium">Kota Asal</label>
                            <input type="text" id="new-member-city" class="mt-1 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="new-package" class="block text-sm font-medium">Pilihan Paket</label>
                            <select id="new-package" class="mt-1 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5">
                                <option value="stater">Stater Pass (1 Minggu Gratis)</option>
                                <option value="project">Project Pass (1 Minggu - 25K)</option>
                                <option value="creator">Creator Pass (1 Bulan - 49K)</option>
                                <option value="studio">Studio Pass (1 Tahun - 489K)</option>
                                <option value="observer">Pengamat (Bypass Maintenance)</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Buat Voucher</button>
                    </form>
                    <div id="new-voucher-result" class="mt-4 bg-gray-900 p-3 rounded-lg hidden">
                        <p class="text-green-400">Voucher berhasil dibuat!</p>
                        <p class="text-sm">Kode: <strong id="generated-voucher-code" class="text-lg text-yellow-300"></strong></p>
                    </div>
                </div>

                <!-- Kolom 2: Daftar Member -->
                <div class="lg:col-span-2 bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                       <h2 class="text-lg sm:text-xl font-semibold">Daftar Member</h2>
                       <button id="refresh-members-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2 rounded-lg" title="Refresh data">
                           <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24" stroke-width="1.5" stroke="currentColor">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-11.664 0l-3.182-3.182a8.25 8.25 0 0111.664 0l3.182 3.182" />
                           </svg>
                       </button>
                    </div>

                    <!-- Tampilan Tabel untuk Desktop -->
                    <div class="overflow-x-auto max-h-96 hidden md:block">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Nama</th>
                                    <th scope="col" class="px-6 py-3">Kota Asal</th>
                                    <th scope="col" class="px-6 py-3">Paket</th>
                                    <th scope="col" class="px-6 py-3">Sisa Waktu</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                    <th scope="col" class="px-6 py-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body">
                                <!-- Data table dimuat di sini -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Tampilan Kartu untuk Mobile -->
                    <div id="members-card-view" class="md:hidden space-y-3 max-h-96 overflow-y-auto">
                        <!-- Data card dimuat di sini -->
                    </div>

                </div>
                
                <!-- Kolom 3: Pengaturan Fitur -->
                <div class="lg:col-span-3 bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
                     <h2 class="text-lg sm:text-xl font-semibold mb-4">Pengaturan Fitur Global</h2>
                     <div class="space-y-4">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-700 p-4 rounded-lg">
                            <div class="mb-3 sm:mb-0 sm:mr-4">
                               <p class="font-medium text-white">Fitur "Advanced Control Sliders"</p>
                               <p class="text-sm text-gray-400">Aktifkan untuk menampilkan panel kontrol lanjutan bagi semua member.</p>
                            </div>
                            <label class="switch flex-shrink-0">
                               <input type="checkbox" id="feature-toggle">
                               <span class="slider"></span>
                           </label>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                                <div class="mb-3 sm:mb-0 sm:mr-4">
                                   <p class="font-medium text-white">Mode Perbaikan (Maintenance)</p>
                                   <p class="text-sm text-gray-400">Jika aktif, member tidak akan bisa login.</p>
                                </div>
                                <label class="switch flex-shrink-0">
                                   <input type="checkbox" id="maintenance-toggle">
                                   <span class="slider"></span>
                               </label>
                            </div>
                            <div class="mt-4">
                                <label for="maintenance-message-input" class="block text-sm font-medium mb-1">Pesan Perbaikan</label>
                                <textarea id="maintenance-message-input" rows="2" class="bg-gray-900 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Contoh: Aplikasi sedang dalam perbaikan hingga jam 15:00."></textarea>
                                <button id="save-maintenance-message-btn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-3 rounded-lg">Simpan Pesan</button>
                            </div>
                        </div>
                     </div>
                     <p id="feature-save-status" class="text-green-400 text-sm mt-3 h-4 text-center"></p>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Permintaan Voucher -->
    <div id="voucher-request-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 fade-in">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-md relative">
            <button id="close-request-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0-0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-xl sm:text-2xl font-bold text-center text-blue-400 mb-6">Formulir Permintaan Voucher</h2>
            <form id="voucher-request-form" class="space-y-4">
                <div>
                    <label for="request-name" class="block text-sm font-medium">Nama Anda</label>
                    <input type="text" id="request-name" class="mt-1 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required placeholder="Contoh: Budi Santoso">
                </div>
                <div>
                    <label for="request-city" class="block text-sm font-medium">Kota Asal</label>
                    <input type="text" id="request-city" class="mt-1 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required placeholder="Contoh: Jakarta">
                </div>
                <div>
                    <label for="request-package" class="block text-sm font-medium">Pilih Paket</label>
                    <select id="request-package" class="mt-1 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5">
                        <option value="Stater Pass (Gratis)">Stater Pass (Gratis)</option>
                        <option value="Project Pass (25K)">Project Pass (25K)</option>
                        <option value="Creator Pass (49K)">Creator Pass (49K)</option>
                        <option value="Studio Pass (489K)">Studio Pass (489K)</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0-0 24 24" fill="currentColor"><path d="M16.604 11.048a.75.75 0 01.446-1.424l1.414.424a.75.75 0 01.424 1.414l-4.242 1.273a.75.75 0 01-.849-.217l-1.273-1.794a.75.75 0 01.217-.849l1.794-1.273a.75.75 0 011.06.217l.284.398zm-4.156-3.101a.75.75 0 011.06-.217l4.243 3.03a.75.75 0 01.217 1.06l-3.03 4.243a.75.75 0 01-1.06.217l-4.243-3.03a.75.75 0 01-.217-1.06l3.03-4.243zM6.16 11.595a.75.75 0 01.849.217l1.273 1.794a.75.75 0 01-.217.849l-1.794 1.273a.75.75 0 01-1.06-.217l-.284-.398a.75.75 0 01.446-1.424l1.414-.424a.75.75 0 01.424-1.414zM12 2.25A9.75 9.75 0 1021.75 12 9.761 9.761 0 0012 2.25z"/></svg>
                    Kirim via WhatsApp
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 fade-in">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-sm relative">
            <h2 class="text-xl font-bold text-center text-red-400 mb-4">Konfirmasi Hapus</h2>
            <p id="delete-confirm-text" class="text-center text-gray-300 mb-6">Apakah Anda yakin ingin menghapus voucher untuk member ini?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Batal</button>
                <button id="confirm-delete-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Hapus</button>
            </div>
        </div>
    </div>


    <!-- Firebase dan Logic Aplikasi -->
    <script type="module">
        // Impor fungsi-fungsi Firebase yang dibutuhkan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithEmailAndPassword, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, serverTimestamp, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6_SqZDftPnMNvOtPJ_WMD-yxz7qaMkDo",
            authDomain: "kunci-b42e7.firebaseapp.com",
            projectId: "kunci-b42e7",
            storageBucket: "kunci-b42e7.appspot.com",
            messagingSenderId: "29581913558",
            appId: "1:29581913558:web:ccad295d29918d545ec877",
            measurementId: "G-CN5M29JLK3"
        };
        
        // =================================================================================
        // PERINGATAN KEAMANAN & KONFIGURASI
        // =================================================================================
        // 1. UID ADMIN: Ini adalah satu-satunya UID yang diizinkan mengakses panel admin.
        const ADMIN_UID = "qk3es4chLkZpSosuRBbywS6v0VJ2";
        // 2. NOMOR WHATSAPP ADMIN
        const ADMIN_WHATSAPP_NUMBER = "6289660111433";
        // =================================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 

        let currentUserData = null;
        let lastGeneratedPromptData = null; 
        const DAILY_LIMIT = 5;

        const keyMap = {
            indonesia: {
                desc: 'Deskripsi',
                style: 'Gaya_Visual',
                light: 'Pencahayaan',
                mood: 'Suasana_&_Mood',
                tech: 'Teknis'
            },
            english: {
                desc: 'Description',
                style: 'Visual_Style',
                light: 'Lighting',
                mood: 'Atmosphere_&_Mood',
                tech: 'Technical'
            }
        };

        // =================================================================================
        // REFERENSI ELEMEN DOM
        // =================================================================================
        const loginPage = document.getElementById('login-page');
        const memberPage = document.getElementById('member-page');
        const adminPage = document.getElementById('admin-page');
        const memberName = document.getElementById('member-name');
        const packageNameDisplay = document.getElementById('package-name-display');
        const expiryTime = document.getElementById('expiry-time');
        const memberLogoutBtn = document.getElementById('member-logout');
        const usageLimitDisplay = document.getElementById('usage-limit-display');
        const imageUploadArea = document.getElementById('image-upload-area');
        const imageInput = document.getElementById('image-input');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const imagePreview = document.getElementById('image-preview');
        const generatePromptBtn = document.getElementById('generate-prompt-btn');
        const promptContent = document.getElementById('prompt-content');
        const memberError = document.getElementById('member-error');
        const adminLogoutBtn = document.getElementById('admin-logout');
        const createVoucherForm = document.getElementById('create-voucher-form');
        const newMemberNameInput = document.getElementById('new-member-name');
        const newMemberCityInput = document.getElementById('new-member-city');
        const newPackageInput = document.getElementById('new-package');
        const newVoucherResult = document.getElementById('new-voucher-result');
        const generatedVoucherCode = document.getElementById('generated-voucher-code');
        const membersTableBody = document.getElementById('members-table-body');
        const membersCardView = document.getElementById('members-card-view');
        const refreshMembersBtn = document.getElementById('refresh-members-btn');
        const featureToggle = document.getElementById('feature-toggle');
        const featureSaveStatus = document.getElementById('feature-save-status');
        const loadingSpinner = document.getElementById('loading-spinner');
        const promptPlaceholder = document.getElementById('prompt-placeholder');
        const voucherCodeInput = document.getElementById('voucher-code');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginError = document.getElementById('login-error');
        const showMemberLoginBtn = document.getElementById('show-member-login');
        const showAdminLoginBtn = document.getElementById('show-admin-login');
        const memberLoginForm = document.getElementById('member-login-form');
        const adminLoginForm = document.getElementById('admin-login-form');
        const memberLoginBtn = document.getElementById('member-login-btn');
        const controlsAndCopyContainer = document.getElementById('controls-and-copy-container');
        const advancedControlsSection = document.getElementById('advanced-controls-section');
        const premiumFeatureLock = document.getElementById('premium-feature-lock');
        const slidersWrapper = document.getElementById('sliders-wrapper');
        const resultTitle = document.getElementById('result-title');
        const copyPromptSection = document.getElementById('copy-prompt-section');
        const copyDropdownToggle = document.getElementById('copy-dropdown-toggle');
        const copyDropdownMenu = document.getElementById('copy-dropdown-menu');
        const copyIndonesiaBtn = document.getElementById('copy-indonesia-btn');
        const copyEnglishBtn = document.getElementById('copy-english-btn');
        const artisticStyleSlider = document.getElementById('artistic-style-slider');
        const detailLevelSlider = document.getElementById('detail-level-slider');
        const moodSlider = document.getElementById('mood-slider');
        const artisticStyleValue = document.getElementById('artistic-style-value');
        const detailLevelValue = document.getElementById('detail-level-value');
        const moodValue = document.getElementById('mood-value');
        const totalMembersStat = document.getElementById('total-members');
        const activeMembersStat = document.getElementById('active-members');
        const inactiveMembersStat = document.getElementById('inactive-members');
        const onlineMembersStat = document.getElementById('online-members');
        const offlineMembersStat = document.getElementById('offline-members');
        const voucherRequestModal = document.getElementById('voucher-request-modal');
        const showRequestModalBtn = document.getElementById('show-request-modal-btn');
        const closeRequestModalBtn = document.getElementById('close-request-modal-btn');
        const voucherRequestForm = document.getElementById('voucher-request-form');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmText = document.getElementById('delete-confirm-text');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const maintenanceToggle = document.getElementById('maintenance-toggle');
        const maintenanceMessageInput = document.getElementById('maintenance-message-input');
        const saveMaintenanceMessageBtn = document.getElementById('save-maintenance-message-btn');
        const maintenanceNotice = document.getElementById('maintenance-notice');
        const maintenanceMessageDisplay = document.getElementById('maintenance-message-display');
        let memberIdToDelete = null;

        // =================================================================================
        // FUNGSI UTAMA & LOGIKA
        // =================================================================================

        function showPage(pageId) {
            loginPage.classList.add('hidden');
            memberPage.classList.add('hidden');
            adminPage.classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
        }

        showMemberLoginBtn.addEventListener('click', () => {
            adminLoginForm.classList.add('hidden');
            memberLoginForm.classList.remove('hidden');
            showMemberLoginBtn.classList.add('border-blue-400', 'text-white');
            showMemberLoginBtn.classList.remove('border-transparent', 'text-gray-500');
            showAdminLoginBtn.classList.add('border-transparent', 'text-gray-500');
            showAdminLoginBtn.classList.remove('border-blue-400', 'text-white');
            loginError.textContent = '';
        });

        showAdminLoginBtn.addEventListener('click', () => {
            memberLoginForm.classList.add('hidden');
            adminLoginForm.classList.remove('hidden');
            showAdminLoginBtn.classList.add('border-blue-400', 'text-white');
            showAdminLoginBtn.classList.remove('border-transparent', 'text-gray-500');
            showMemberLoginBtn.classList.add('border-transparent', 'text-gray-500');
            showMemberLoginBtn.classList.remove('border-blue-400', 'text-white');
            loginError.textContent = '';
        });
        
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                if (user.uid !== ADMIN_UID) {
                    loginError.textContent = 'Akun ini tidak memiliki hak akses admin.';
                    await signOut(auth);
                }
                // Jika berhasil, onAuthStateChanged akan menangani navigasi halaman
            } catch (error) {
                console.error("Admin Email/Pass sign-in error:", error.code, error.message);
                 switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        loginError.textContent = 'Email atau password salah.';
                        break;
                    case 'auth/invalid-email':
                        loginError.textContent = 'Format email tidak valid.';
                        break;
                    default:
                        loginError.textContent = 'Login gagal, terjadi kesalahan.';
                }
            }
        });

        memberLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const voucherCode = voucherCodeInput.value.trim().toUpperCase();
            if (!voucherCode) return;
            loginError.textContent = '';

            try {
                const deviceId = getDeviceId();
                const settingsDoc = await getDoc(doc(db, "settings", "features"));
                const settings = settingsDoc.exists() ? settingsDoc.data() : {};

                const docRef = doc(db, "vouchers", voucherCode);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    let data = docSnap.data();

                    if (settings.maintenanceModeEnabled && !data.isObserver) {
                        loginError.textContent = settings.maintenanceMessage || 'Sistem sedang dalam perbaikan.';
                        return;
                    }

                    // Logika pengecekan deviceId
                    if (data.boundDeviceId && data.boundDeviceId !== deviceId) {
                        loginError.textContent = 'Voucher ini sudah terikat pada perangkat lain.';
                        return;
                    }

                    if (!data.activated) {
                        let duration;
                        switch(data.packageName) {
                            case 'Stater Pass': duration = 7; break;
                            case 'Project Pass': duration = 7; break;
                            case 'Creator Pass': duration = 30; break;
                            case 'Studio Pass': duration = 360; break; // Diubah sesuai permintaan
                            case 'Pengamat': duration = 365; break;
                            default: duration = 0;
                        }
                        const expiryDate = new Date();
                        expiryDate.setDate(expiryDate.getDate() + duration);
                        
                        await updateDoc(docRef, {
                            activated: true,
                            expiresAt: Timestamp.fromDate(expiryDate),
                            firstLoginAt: serverTimestamp(),
                            boundDeviceId: deviceId // Mengikat deviceId saat aktivasi
                        });
                        
                        data.activated = true;
                        data.expiresAt = Timestamp.fromDate(expiryDate);
                        data.boundDeviceId = deviceId;
                        data.isFirstLogin = true; // Tandai ini sebagai login pertama
                    }

                    const expiresAt = data.expiresAt.toDate();
                    if (expiresAt > new Date()) {
                        currentUserData = { id: docSnap.id, ...data };
                        
                        const storableUserData = {
                            ...currentUserData,
                            expiresAt: currentUserData.expiresAt.toMillis(),
                            createdAt: currentUserData.createdAt ? currentUserData.createdAt.toMillis() : null,
                            firstLoginAt: currentUserData.firstLoginAt ? currentUserData.firstLoginAt.toMillis() : null,
                            lastSeen: currentUserData.lastSeen ? currentUserData.lastSeen.toMillis() : null,
                            isFirstLogin: currentUserData.isFirstLogin || false
                        };
                        sessionStorage.setItem('loggedInUser', JSON.stringify(storableUserData));

                        await setupMemberPage();
                        showPage('member-page');
                    } else {
                        loginError.textContent = 'Voucher Anda sudah kedaluwarsa.';
                    }
                } else {
                    loginError.textContent = 'Kode voucher tidak ditemukan.';
                }
            } catch (error) {
                console.error("Error logging in member:", error.code, error.message);
                loginError.textContent = 'Terjadi kesalahan. Coba lagi.';
            }
        });

        showRequestModalBtn.addEventListener('click', () => voucherRequestModal.classList.remove('hidden'));
        closeRequestModalBtn.addEventListener('click', () => voucherRequestModal.classList.add('hidden'));
        voucherRequestModal.addEventListener('click', (e) => {
            if (e.target === voucherRequestModal) {
                voucherRequestModal.classList.add('hidden');
            }
        });

        voucherRequestForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('request-name').value.trim();
            const city = document.getElementById('request-city').value.trim();
            const selectedPackage = document.getElementById('request-package').value;

            const message = `Halo Admin,\n\nSaya ingin meminta voucher akses dengan detail berikut:\n\n*Nama:* ${name}\n*Kota Asal:* ${city}\n*Paket:* ${selectedPackage}\n\nMohon informasinya. Terima kasih.`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/${ADMIN_WHATSAPP_NUMBER}?text=${encodedMessage}`;

            window.open(whatsappURL, '_blank');
            voucherRequestForm.reset();
            voucherRequestModal.classList.add('hidden');
        });

        async function setupMemberPage() {
            if (!currentUserData) return;
            memberName.textContent = currentUserData.name;
            packageNameDisplay.textContent = currentUserData.packageName;
            
            if (currentUserData.isFirstLogin) {
                let fullDurationText = '';
                switch(currentUserData.packageName) {
                    case 'Stater Pass':
                    case 'Project Pass':
                        fullDurationText = '7 hari';
                        break;
                    case 'Creator Pass':
                        fullDurationText = '30 hari';
                        break;
                    case 'Studio Pass':
                        fullDurationText = '360 hari';
                        break;
                    case 'Pengamat':
                        fullDurationText = '365 hari';
                        break;
                    default:
                        const remainingDays = Math.ceil((currentUserData.expiresAt - new Date()) / (1000 * 60 * 60 * 24));
                        fullDurationText = `${remainingDays} hari`;
                }
                expiryTime.textContent = fullDurationText;

                // Hapus flag setelah ditampilkan agar tidak muncul lagi
                delete currentUserData.isFirstLogin;
                const storableUserData = JSON.parse(sessionStorage.getItem('loggedInUser'));
                delete storableUserData.isFirstLogin;
                sessionStorage.setItem('loggedInUser', JSON.stringify(storableUserData));
            } else {
                const remainingDays = Math.ceil((currentUserData.expiresAt - new Date()) / (1000 * 60 * 60 * 24));
                expiryTime.textContent = `${remainingDays} hari`;
            }


            if (currentUserData.type === 'stater') {
                const today = getTodayDateString();
                let currentUsage = currentUserData.usageCount || 0;
                if(currentUserData.lastUsedDate !== today) {
                    currentUsage = 0;
                }
                usageLimitDisplay.textContent = `Jatah hari ini: ${DAILY_LIMIT - currentUsage} / ${DAILY_LIMIT}`;
            } else {
                usageLimitDisplay.textContent = 'Jatah: Tidak terbatas';
            }

            await updateDoc(doc(db, "vouchers", currentUserData.id), {
                lastSeen: serverTimestamp(),
                status: 'online'
            });
        }
        
        memberLogoutBtn.addEventListener('click', async () => {
             if (currentUserData) {
                await updateDoc(doc(db, "vouchers", currentUserData.id), { status: 'offline' });
             }
             currentUserData = null;
             sessionStorage.clear();
             location.reload();
        });

        imageUploadArea.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', handleImageSelect);
        
        imageUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); imageUploadArea.classList.add('border-blue-500', 'bg-gray-700'); });
        imageUploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); imageUploadArea.classList.remove('border-blue-500', 'bg-gray-700'); });
        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('border-blue-500', 'bg-gray-700');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                imageInput.files = e.dataTransfer.files;
                handleImageSelect();
            }
        });

        function handleImageSelect() {
            const file = imageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                    generatePromptBtn.disabled = false;
                }
                reader.readAsDataURL(file);
            }
        }

        generatePromptBtn.addEventListener('click', generatePrompt);

        async function generatePrompt() {
            if (!imageInput.files[0] || !currentUserData) return;
            memberError.textContent = '';
            const today = getTodayDateString();

            if (currentUserData.type === 'stater') {
                let usageCount = currentUserData.usageCount || 0;
                if (currentUserData.lastUsedDate !== today) usageCount = 0;
                if (usageCount >= DAILY_LIMIT) {
                    memberError.textContent = `Jatah gratis Anda (${DAILY_LIMIT}x sehari) sudah habis. Coba lagi besok.`;
                    return;
                }
            }
            
            controlsAndCopyContainer.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            promptPlaceholder.classList.add('hidden');
            promptContent.classList.add('hidden');
            generatePromptBtn.disabled = true;

            try {
                const base64ImageData = await imageToBase64(imageInput.files[0]);
                
                const model = 'gemini-2.5-flash-preview-05-20';
                
                const apiKey = "MASUKKAN_API_KEY_ANDA_DI_SINI"; 

                if (apiKey === "MASUKKAN_API_KEY_ANDA_DI_SINI") {
                    throw new Error("API Key belum dimasukkan. Silakan dapatkan dari Google AI Studio dan masukkan ke dalam kode.");
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                const systemPrompt = `Kamu adalah Prompt Generator ahli untuk AI Art. Analisis gambar dan buat deskripsi teknis dan sistematis. Balas HANYA dalam format JSON yang valid tanpa markdown. JSON harus memiliki dua kunci utama: "indonesia" dan "english".  Kunci "indonesia" harus berisi objek dengan kunci berikut: "Deskripsi", "Gaya_Visual", "Pencahayaan", "Suasana_&_Mood", dan "Teknis". - Deskripsi: Identifikasi subjek utama, pose, sudut kamera, pakaian/penampilan, dan latar belakang. - Gaya_Visual: Tentukan gaya (contoh: hiper-realistis, sinematik, ilustrasi kartun). - Pencahayaan: Analisis sumber cahaya (contoh: natural, spotlight, dramatis). - Suasana_&_Mood: Deskripsikan nuansa emosional (contoh: tenang, mistis, ceria). - Teknis: Tambahkan detail teknis seperti jenis kamera, lensa, atau resolusi jika relevan.  Kunci "english" harus berisi objek dengan kunci yang sama dalam Bahasa Inggris: "Description", "Visual_Style", "Lighting", "Atmosphere_&_Mood", dan "Technical".  Lakukan analisis yang sama untuk versi Bahasa Inggris. Hindari deskripsi klise seperti 'sangat indah'. Fokus pada detail objektif.`;

                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{
                        role: "user",
                        parts: [
                            { text: "Analisis gambar ini dan berikan output JSON sesuai instruksi." },
                            { inlineData: { mimeType: imageInput.files[0].type, data: base64ImageData } }
                        ]
                    }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                
                const textResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResponse) {
                    throw new Error("Struktur respons API tidak valid atau kosong.");
                }

                lastGeneratedPromptData = JSON.parse(textResponse); 
                
                displayPromptResults(lastGeneratedPromptData);
                
                const settingsDoc = await getDoc(doc(db, "settings", "features"));
                const isAdvancedEnabled = settingsDoc.exists() && settingsDoc.data().advancedSlidersEnabled;
                advancedControlsSection.style.display = isAdvancedEnabled ? 'block' : 'none';

                if (currentUserData.type === 'stater' || currentUserData.type === 'observer') {
                    if(currentUserData.type === 'stater'){
                        premiumFeatureLock.classList.remove('hidden');
                    }
                    artisticStyleSlider.disabled = true;
                    detailLevelSlider.disabled = true;
                    moodSlider.disabled = true;
                    slidersWrapper.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    artisticStyleSlider.disabled = false;
                    detailLevelSlider.disabled = false;
                    moodSlider.disabled = false;
                    slidersWrapper.classList.remove('opacity-50', 'cursor-not-allowed');
                    premiumFeatureLock.classList.add('hidden');
                }

                controlsAndCopyContainer.classList.remove('hidden');

                if (currentUserData.type === 'stater') {
                    const userDocRef = doc(db, "vouchers", currentUserData.id);
                    let newUsageCount = (currentUserData.lastUsedDate !== today) ? 1 : (currentUserData.usageCount || 0) + 1;
                    
                    await updateDoc(userDocRef, { usageCount: newUsageCount, lastUsedDate: today });
                    
                    const updatedUserData = { ...currentUserData, usageCount: newUsageCount, lastUsedDate: today };
                    
                    const storableUserData = {
                        ...updatedUserData,
                        expiresAt: updatedUserData.expiresAt.getTime(),
                        createdAt: updatedUserData.createdAt ? updatedUserData.createdAt.getTime() : null,
                        firstLoginAt: updatedUserData.firstLoginAt ? updatedUserData.firstLoginAt.getTime() : null,
                        lastSeen: updatedUserData.lastSeen ? updatedUserData.lastSeen.getTime() : null,
                    };
                    sessionStorage.setItem('loggedInUser', JSON.stringify(storableUserData));
                    usageLimitDisplay.textContent = `Jatah hari ini: ${DAILY_LIMIT - newUsageCount} / ${DAILY_LIMIT}`;
                }

            } catch (error) {
                console.error("Error generating prompt:", error);
                memberError.textContent = "Gagal menganalisis gambar. Coba lagi nanti.";
                promptPlaceholder.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
                generatePromptBtn.disabled = false;
            }
        }
        
        function displayPromptResults(baseData) {
            promptContent.innerHTML = '';
            
            const modifiedData = JSON.parse(JSON.stringify(baseData)); 
            
            let modifiers = { english: '', indonesia: '' };
            if (currentUserData.type !== 'stater' && currentUserData.type !== 'observer') {
                modifiers = getAdvancedModifiers();
            }

            if (modifiedData.english && modifiedData.english.Description) {
                modifiedData.english.Description += modifiers.english;
            }
            if (modifiedData.indonesia && modifiedData.indonesia.Deskripsi) {
                modifiedData.indonesia.Deskripsi += modifiers.indonesia;
            }

            const languages = { 'indonesia': 'Indonesia', 'english': 'English' };

            for (const lang in languages) {
                if (modifiedData[lang]) {
                    const langData = modifiedData[lang];
                    const currentKeys = keyMap[lang];
                    const langContainer = document.createElement('div');
                    langContainer.className = 'bg-gray-700 p-4 rounded-lg';
                    langContainer.innerHTML = `
                        <h3 class="text-lg font-semibold text-blue-300 mb-3">${sanitizeHTML(languages[lang])}</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong class="text-gray-400">Deskripsi:</strong> ${sanitizeHTML(langData[currentKeys.desc] || '')}</p>
                            <p><strong class="text-gray-400">Gaya Visual:</strong> ${sanitizeHTML(langData[currentKeys.style] || '')}</p>
                            <p><strong class="text-gray-400">Pencahayaan:</strong> ${sanitizeHTML(langData[currentKeys.light] || '')}</p>
                            <p><strong class="text-gray-400">Suasana & Mood:</strong> ${sanitizeHTML(langData[currentKeys.mood] || '')}</p>
                            <p><strong class="text-gray-400">Teknis:</strong> ${sanitizeHTML(langData[currentKeys.tech] || '')}</p>
                        </div>
                    `;
                    promptContent.appendChild(langContainer);
                }
            }
            promptContent.classList.remove('hidden');
        }

        function updateSliderValue(slider, label) {
            const value = parseInt(slider.value);
            if (value < 20) label.textContent = slider.nextElementSibling.children[0].textContent;
            else if (value > 80) label.textContent = slider.nextElementSibling.children[1].textContent;
            else if (value >= 40 && value <= 60) {
                const neutralText = label.id.includes('artistic') ? 'Seimbang' : (label.id.includes('detail') ? 'Normal' : 'Netral');
                label.textContent = neutralText;
            }
            else {
                const tendency = value > 50 ? slider.nextElementSibling.children[1].textContent : slider.nextElementSibling.children[0].textContent;
                label.textContent = `Cenderung ${tendency}`;
            }
            
            if (lastGeneratedPromptData) {
                displayPromptResults(lastGeneratedPromptData);
            }
        }

        artisticStyleSlider.addEventListener('input', () => updateSliderValue(artisticStyleSlider, artisticStyleValue));
        detailLevelSlider.addEventListener('input', () => updateSliderValue(detailLevelSlider, detailLevelValue));
        moodSlider.addEventListener('input', () => updateSliderValue(moodSlider, moodValue));

        function getAdvancedModifiers() {
            let eng = [];
            let idn = [];

            const artVal = parseInt(artisticStyleSlider.value);
            if (artVal < 20) { eng.push('illustration style'); idn.push('gaya ilustrasi'); }
            else if (artVal < 40) { eng.push('artistic illustration'); idn.push('ilustrasi artistik'); }
            else if (artVal > 80) { eng.push('photorealistic, 8k'); idn.push('fotorealistis, 8k'); }
            else if (artVal > 60) { eng.push('realistic photograph'); idn.push('foto realistis'); }

            const detailVal = parseInt(detailLevelSlider.value);
            if (detailVal < 20) { eng.push('minimalist'); idn.push('minimalis'); }
            else if (detailVal < 40) { eng.push('simple details'); idn.push('detail sederhana'); }
            else if (detailVal > 80) { eng.push('highly detailed, intricate'); idn.push('sangat detail, rumit'); }
            else if (detailVal > 60) { eng.push('complex details'); idn.push('detail kompleks'); }

            const moodVal = parseInt(moodSlider.value);
            if (moodVal < 20) { eng.push('bright and cheerful'); idn.push('cerah dan ceria'); }
            else if (moodVal < 40) { eng.push('soft lighting'); idn.push('pencahayaan lembut'); }
            else if (moodVal > 80) { eng.push('dramatic lighting, cinematic'); idn.push('pencahayaan dramatis, sinematik'); }
            else if (moodVal > 60) { eng.push('moody atmosphere'); idn.push('suasana muram'); }
            
            return {
                english: eng.length > 0 ? ', ' + eng.join(', ') : '',
                indonesia: idn.length > 0 ? ', ' + idn.join(', ') : ''
            };
        }
        
        copyDropdownToggle.addEventListener('click', () => {
            copyDropdownMenu.classList.toggle('hidden');
        });

        function handleCopy(lang) {
            if (!lastGeneratedPromptData || !lastGeneratedPromptData[lang]) return;
            
            const baseData = lastGeneratedPromptData[lang];
            const currentKeys = keyMap[lang];
            let modifiers = { english: '', indonesia: '' }; 
            
            if (currentUserData.type !== 'stater' && currentUserData.type !== 'observer') {
                modifiers = getAdvancedModifiers();
            }

            const promptParts = [
                baseData[currentKeys.desc],
                baseData[currentKeys.style],
                baseData[currentKeys.light],
                baseData[currentKeys.mood],
                baseData[currentKeys.tech]
            ].filter(Boolean);

            let fullPrompt = promptParts.join(', ');
            if (modifiers[lang]) {
                fullPrompt += modifiers[lang];
            }
            
            copyTextToClipboard(fullPrompt);
            copyDropdownMenu.classList.add('hidden');
            const originalHTML = copyDropdownToggle.innerHTML;
            copyDropdownToggle.innerHTML = `<span>Tersalin!</span>`;
            setTimeout(() => { copyDropdownToggle.innerHTML = originalHTML; }, 2000);
        }

        copyIndonesiaBtn.addEventListener('click', () => handleCopy('indonesia'));
        copyEnglishBtn.addEventListener('click', () => handleCopy('english'));


        function setupAdminPage() {
            loadMembers();
            loadFeatureSettings();
        }

        adminLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Admin sign out error:", error);
            }
        });

        refreshMembersBtn.addEventListener('click', loadMembers);

        createVoucherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = newMemberNameInput.value;
            const city = newMemberCityInput.value;
            const selectedPackage = newPackageInput.value;

            let voucherData = { 
                name, 
                kotaAsal: city, 
                createdAt: serverTimestamp(), 
                status: 'offline', 
                lastSeen: null,
                activated: false, 
                expiresAt: null,
                firstLoginAt: null,
                boundDeviceId: null // Tambahkan field kosong saat pembuatan
            };

            switch(selectedPackage) {
                case 'stater':
                    voucherData = { ...voucherData, type: 'stater', packageName: 'Stater Pass', usageCount: 0, lastUsedDate: null };
                    break;
                case 'project':
                    voucherData = { ...voucherData, type: 'premium', packageName: 'Project Pass' };
                    break;
                case 'creator':
                    voucherData = { ...voucherData, type: 'premium', packageName: 'Creator Pass' };
                    break;
                case 'studio':
                    voucherData = { ...voucherData, type: 'premium', packageName: 'Studio Pass' };
                    break;
                case 'observer':
                    voucherData = { ...voucherData, type: 'observer', packageName: 'Pengamat', isObserver: true };
                    break;
            }
            
            const newCode = generateVoucherCode();

            try {
                await setDoc(doc(db, "vouchers", newCode), voucherData);
                generatedVoucherCode.textContent = newCode;
                newVoucherResult.classList.remove('hidden');
                createVoucherForm.reset();
                loadMembers();
            } catch (error) {
                console.error("Error creating voucher: ", error);
                alert("Gagal membuat voucher.");
            }
        });
        
        async function loadMembers() {
            const loadingHtml = `<div class="text-center p-4">Memuat data member...</div>`;
            membersTableBody.innerHTML = `<tr><td colspan="6">${loadingHtml}</td></tr>`;
            membersCardView.innerHTML = loadingHtml;

            try {
                const querySnapshot = await getDocs(collection(db, "vouchers"));
                let tableHtml = '';
                let cardHtml = '';

                let total = 0, active = 0, inactive = 0, online = 0, offline_but_active = 0;

                if (querySnapshot.empty) {
                     const emptyHtml = `<div class="text-center p-4">Belum ada member.</div>`;
                     membersTableBody.innerHTML = `<tr><td colspan="6">${emptyHtml}</td></tr>`;
                     membersCardView.innerHTML = emptyHtml;
                     return;
                }

                querySnapshot.forEach((docSnap) => {
                    total++;
                    const member = docSnap.data();
                    const memberId = docSnap.id;
                    let statusHtml, remainingDaysText;

                    if (member.activated) {
                        active++;
                        const expiresAt = member.expiresAt.toDate();
                        const remainingDays = Math.max(0, Math.ceil((expiresAt - new Date()) / (1000 * 60 * 60 * 24)));
                        remainingDaysText = `${remainingDays} hari`;
                        
                        if (member.status === 'online' && member.lastSeen && (new Date() - member.lastSeen.toDate()) / (1000 * 60) < 5) {
                            online++;
                            statusHtml = `<span class="bg-green-600 text-green-100 text-xs font-medium px-2.5 py-0.5 rounded-full">Online</span>`;
                        } else {
                            offline_but_active++;
                            statusHtml = `<span class="bg-gray-600 text-gray-200 text-xs font-medium px-2.5 py-0.5 rounded-full">Offline</span>`;
                        }
                    } else {
                        inactive++;
                        remainingDaysText = 'N/A';
                        statusHtml = `<span class="bg-purple-600 text-purple-100 text-xs font-medium px-2.5 py-0.5 rounded-full">Belum Aktif</span>`;
                    }
                    
                    const deleteButtonHtml = `<button data-id="${sanitizeHTML(memberId)}" data-name="${sanitizeHTML(member.name)}" class="delete-member-btn text-red-400 hover:text-red-300 font-medium">Hapus</button>`;
                    const observerBadge = member.isObserver ? `<span class="ml-2 bg-cyan-600 text-cyan-100 text-xs font-medium px-2.5 py-0.5 rounded-full">Pengamat</span>` : '';
                    
                    tableHtml += `
                        <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-600">
                            <td class="px-6 py-4 font-medium text-white whitespace-nowrap">${sanitizeHTML(member.name)}</td>
                            <td class="px-6 py-4">${sanitizeHTML(member.kotaAsal || '-')}</td>
                            <td class="px-6 py-4">${sanitizeHTML(member.packageName || 'Lama')} ${observerBadge}</td>
                            <td class="px-6 py-4">${sanitizeHTML(remainingDaysText)}</td>
                            <td class="px-6 py-4">${statusHtml}</td>
                            <td class="px-6 py-4 text-center">${deleteButtonHtml}</td>
                        </tr>
                    `;

                    cardHtml += `
                        <div class="bg-gray-700 p-4 rounded-lg shadow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-white">${sanitizeHTML(member.name)}</p>
                                    <p class="text-sm text-gray-400">${sanitizeHTML(member.kotaAsal || 'Kota tidak diketahui')}</p>
                                </div>
                                ${statusHtml}
                            </div>
                            <div class="mt-3 border-t border-gray-600 pt-3 text-sm space-y-1">
                                <p><strong class="text-gray-400">Paket:</strong> ${sanitizeHTML(member.packageName || 'Lama')} ${observerBadge}</p>
                                <p><strong class="text-gray-400">Sisa Waktu:</strong> ${sanitizeHTML(remainingDaysText)}</p>
                                <p><strong class="text-gray-400">Kode:</strong> <span class="font-mono">${sanitizeHTML(memberId)}</span></p>
                            </div>
                            <button data-id="${sanitizeHTML(memberId)}" data-name="${sanitizeHTML(member.name)}" class="delete-member-btn mt-3 w-full bg-red-600/50 hover:bg-red-600 text-white text-sm font-bold py-2 px-3 rounded-lg transition-colors">Hapus Voucher</button>
                        </div>
                    `;
                });

                membersTableBody.innerHTML = tableHtml;
                membersCardView.innerHTML = cardHtml;

                totalMembersStat.textContent = total;
                activeMembersStat.textContent = active;
                inactiveMembersStat.textContent = inactive;
                onlineMembersStat.textContent = online;
                offlineMembersStat.textContent = offline_but_active;

            } catch (error) {
                console.error("Error loading members: ", error);
                const errorHtml = `<div class="text-center p-4 text-red-400">Gagal memuat daftar member. Ini mungkin karena Aturan Keamanan yang melarang pengambilan daftar.</div>`;
                membersTableBody.innerHTML = `<tr><td colspan="6">${errorHtml}</td></tr>`;
                membersCardView.innerHTML = errorHtml;
            }
        }
        
        function handleMemberAction(e) {
            if (e.target.classList.contains('delete-member-btn')) {
                const memberId = e.target.dataset.id;
                const memberName = e.target.dataset.name;
                showDeleteConfirmation(memberId, memberName);
            }
        }

        membersTableBody.addEventListener('click', handleMemberAction);
        membersCardView.addEventListener('click', handleMemberAction);

        function showDeleteConfirmation(memberId, memberName) {
            memberIdToDelete = memberId;
            deleteConfirmText.textContent = `Apakah Anda yakin ingin menghapus voucher untuk member "${sanitizeHTML(memberName)}"? Tindakan ini tidak dapat diurungkan.`;
            deleteConfirmModal.classList.remove('hidden');
        }

        cancelDeleteBtn.addEventListener('click', () => {
            deleteConfirmModal.classList.add('hidden');
            memberIdToDelete = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (memberIdToDelete) {
                try {
                    await deleteDoc(doc(db, "vouchers", memberIdToDelete));
                } catch (error) {
                    console.error("Error deleting member:", error);
                    alert('Gagal menghapus member.');
                } finally {
                    deleteConfirmModal.classList.add('hidden');
                    memberIdToDelete = null;
                    loadMembers(); 
                }
            }
        });
        
        async function updateFeatureSettings(settings) {
             try {
                await setDoc(doc(db, "settings", "features"), settings, { merge: true });
                featureSaveStatus.textContent = "Pengaturan disimpan!";
                setTimeout(() => { featureSaveStatus.textContent = ''; }, 2000);
            } catch(error) {
                console.error("Error updating feature setting:", error);
                featureSaveStatus.textContent = "Gagal menyimpan!";
                 setTimeout(() => { featureSaveStatus.textContent = ''; }, 2000);
            }
        }
        
        featureToggle.addEventListener('change', (e) => updateFeatureSettings({ advancedSlidersEnabled: e.target.checked }));
        maintenanceToggle.addEventListener('change', (e) => updateFeatureSettings({ maintenanceModeEnabled: e.target.checked }));
        saveMaintenanceMessageBtn.addEventListener('click', () => updateFeatureSettings({ maintenanceMessage: maintenanceMessageInput.value }));


        async function loadFeatureSettings() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "features"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    featureToggle.checked = data.advancedSlidersEnabled || false;
                    maintenanceToggle.checked = data.maintenanceModeEnabled || false;
                    maintenanceMessageInput.value = data.maintenanceMessage || '';
                }
            } catch(error) {
                console.error("Error loading feature settings:", error);
            }
        }

        // --- FUNGSI HELPER ---
        function getTodayDateString() { return new Date().toISOString().split('T')[0]; }
        
        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return str.replace(/[&<>"']/g, (m) => map[m]);
        }

        function copyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.top = "-9999px"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); } catch (err) { console.error('Gagal menyalin teks: ', err); }
            document.body.removeChild(textArea);
        }

        function generateVoucherCode() {
            return crypto.randomUUID().split('-')[0].toUpperCase();
        }

        function imageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = crypto.randomUUID();
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }
        
        // --- Inisialisasi Aplikasi ---
        async function startApp() {
            onAuthStateChanged(auth, async (user) => {
                try {
                    if (!user) {
                        await signInAnonymously(auth);
                    }
                    
                    const settingsDoc = await getDoc(doc(db, "settings", "features"));
                    const settings = settingsDoc.exists() ? settingsDoc.data() : {};

                    if (user && !user.isAnonymous && user.uid === ADMIN_UID) {
                        sessionStorage.removeItem('loggedInUser');
                        setupAdminPage();
                        showPage('admin-page');
                    } else {
                        if (settings.maintenanceModeEnabled) {
                            maintenanceMessageDisplay.textContent = settings.maintenanceMessage || "Aplikasi sedang dalam perbaikan. Silakan coba lagi nanti.";
                            maintenanceNotice.classList.remove('hidden');
                        }
                        
                        const storedUser = sessionStorage.getItem('loggedInUser');
                        if (storedUser) {
                            const parsedUser = JSON.parse(storedUser);
                            currentUserData = {
                                ...parsedUser,
                                expiresAt: new Date(parsedUser.expiresAt),
                                createdAt: parsedUser.createdAt ? new Date(parsedUser.createdAt) : null,
                                firstLoginAt: parsedUser.firstLoginAt ? new Date(parsedUser.firstLoginAt) : null,
                                lastSeen: parsedUser.lastSeen ? new Date(parsedUser.lastSeen) : null,
                            };
                            setupMemberPage();
                            showPage('member-page');
                        } else {
                            showPage('login-page');
                        }
                    }
                } catch (error) {
                    console.error("Initialization failed:", error);
                    document.body.innerHTML = '<div class="text-center text-red-400 p-8">Gagal memuat aplikasi. Periksa aturan keamanan Firestore Anda dan coba lagi.</div>';
                }
            });
        }

        window.onload = startApp;

    </script>
</body>
</html>


